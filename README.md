# Загрузчик железнодорожной сети (Railway Network Loader)

Этот скрипт предназначен для загрузки данных о железнодорожных станциях и путях из OpenStreetMap (OSM) для заданной географической области. Он обрабатывает эти данные, формирует на их основе граф сети и сохраняет результаты в виде набора CSV-файлов.

## Основные возможности

- **Загрузка данных из OSM**: Получает станции и железнодорожные пути через Overpass API.
- **Построение связей**: Определяет прямые соединения между станциями на основе путей.
- **Генерация данных**: Создает списки узловых станций (развязок) и примерный список поездов.
- **Анализ сети**: Строит граф и рассчитывает базовые метрики (количество узлов, связей, хабов).
- **Экспорт в CSV**: Сохраняет все собранные данные в удобные для анализа CSV-файлы.

## Как это работает

1.  **Определение области**: Скрипт использует заданные географические координаты (bounding box) для ограничения области поиска.
2.  **Загрузка станций**: Отправляется запрос в OSM для получения всех объектов, отмеченных как `railway=station` или `railway=halt` в указанной области.
3.  **Загрузка путей**: Отправляется второй запрос для получения всех железнодорожных путей (`railway=rail`).
4.  **Создание связей**: Скрипт "проходит" по каждому пути и, если находит на нем две последовательные станции из загруженного списка, создает между ними связь, рассчитывая расстояние по формуле гаверсинуса.
5.  **Анализ и генерация**:
    -   Станции, имеющие 3 и более соединения, помечаются как **развязки**.
    -   Для демонстрации генерируются **примерные данные о поездах**.
6.  **Сохранение**: Все данные (станции, связи, развязки, поезда) сохраняются в папку `data/` в формате CSV.
7.  **Построение графа**: На основе станций (узлы) и связей (ребра) строится граф с помощью библиотеки `networkx` для дальнейшего анализа.

## Установка

1.  Убедитесь, что у вас установлен Python 3.8 или новее.
2.  Клонируйте репозиторий (или просто скачайте файлы).
3.  Установите все необходимые библиотеки с помощью файла `requirements.txt`:

    ```bash
    pip install -r requirements.txt
    ```

## Использование

1.  Для запуска скрипта выполните в терминале команду:

    ```bash
    python railway_network.py
    ```
    *(предполагается, что вы переименовали основной файл в `railway_network.py`)*

2.  **Настройка области**: По умолчанию скрипт загружает данные для небольшого района Москвы. Чтобы изменить область, отредактируйте переменную `bbox` в функции `main()`:

    ```python
    # Формат: (min_latitude, min_longitude, max_latitude, max_longitude)
    # Пример для Санкт-Петербурга и окрестностей:
    spb_bbox = (59.7, 29.5, 60.2, 30.9)
    ```
    **Внимание**: Не указывайте слишком большую область (например, всю страну), так как сервер Overpass API может отклонить запрос или он будет выполняться очень долго. Для больших территорий требуется более сложная логика с "нарезкой" карты на квадраты.

## Структура выходных данных

Все файлы сохраняются в папку `data/`.

-   `data/stations.csv`: Список всех загруженных станций.
    -   `station_id`: Уникальный ID станции.
    -   `name`: Название станции.
    -   `latitude`, `longitude`: Координаты.
    -   `type`: Тип (station или halt).
    -   `city`: Город (если указан в OSM).
    -   `osm_id`: ID объекта в OpenStreetMap.

-   `data/connections.csv`: Таблица связности (станция-станция).
    -   `connection_id`: Уникальный ID связи.
    -   `station_from`, `station_to`: ID связанных станций.
    -   `distance_km`: Расстояние между ними в км.
    -   `electrified`: Электрифицирован ли путь (`True`/`False`).

-   `data/junctions.csv`: Список узловых станций.
    -   `junction_id`: Уникальный ID развязки.
    -   `station_id`: ID станции, которая является развязкой.
    -   `connected_stations`: JSON-список ID станций, подключенных к развязке.
    -   `connections_count`: Количество подключений.

-   `data/trains.csv`: Примерный список поездов.
    -   `train_id`: Уникальный ID поезда.
    -   `train_number`: Номер поезда.
    -   `name`, `type`: Название и тип.
    -   `route`: JSON-список ID станций, составляющих маршрут.

## Предложение по архитектуре БД

Для эффективного хранения и использования этих данных с целью построения графа оптимально использовать реляционную базу данных (например, PostgreSQL с расширением PostGIS для работы с геоданными) со следующей структурой:

### Таблица 1: `stations` (Станции)
Хранит информацию о каждой станции.

-   `station_id` (VARCHAR(12), PRIMARY KEY) - Уникальный ID, сгенерированный скриптом.
-   `osm_id` (BIGINT, UNIQUE) - ID из OpenStreetMap, для связи с источником.
-   `name` (VARCHAR(255)) - Название станции.
-   `location` (GEOGRAPHY(Point, 4326)) - Координаты (широта, долгота). Использование типа `GEOGRAPHY` позволяет выполнять быстрые гео-запросы (поиск в радиусе и т.д.).
-   `type` (VARCHAR(50)) - Тип (station, halt).
-   `city` (VARCHAR(255), NULLABLE) - Город.

### Таблица 2: `connections` (Соединения)
Описывает прямые железнодорожные пути между станциями (ребра графа).

-   `connection_id` (VARCHAR(12), PRIMARY KEY) - Уникальный ID соединения.
-   `station_from_id` (VARCHAR(12), FOREIGN KEY -> `stations.station_id`) - ID станции отправления.
-   `station_to_id` (VARCHAR(12), FOREIGN KEY -> `stations.station_id`) - ID станции прибытия.
-   `distance_km` (NUMERIC(8, 2)) - Расстояние в километрах.
-   `is_electrified` (BOOLEAN) - Флаг электрификации пути.

*Для неориентированного графа можно добавить `CHECK (station_from_id < station_to_id)`, чтобы избежать дублирования связей (A->B и B->A).*

### Таблица 3: `trains` (Поезда)
Справочник поездов.

-   `train_id` (VARCHAR(12), PRIMARY KEY) - Уникальный ID поезда.
-   `number` (VARCHAR(20), UNIQUE) - Номер поезда (например, "001А").
-   `name` (VARCHAR(255), NULLABLE) - Название поезда ("Красная стрела").
-   `type` (VARCHAR(50)) - Тип (скорый, пассажирский и т.д.).

### Таблица 4: `train_routes` (Маршруты поездов)
Связующая таблица для описания маршрутов (последовательности станций для каждого поезда).

-   `route_point_id` (SERIAL, PRIMARY KEY) - Суррогатный ключ для точки маршрута.
-   `train_id` (VARCHAR(12), FOREIGN KEY -> `trains.train_id`) - ID поезда.
-   `station_id` (VARCHAR(12), FOREIGN KEY -> `stations.station_id`) - ID станции на маршруте.
-   `sequence_order` (INTEGER) - Порядковый номер станции в маршруте (1, 2, 3...).

**Почему такая архитектура оптимальна?**
-   **Нормализация**: Данные не дублируются. Название станции хранится только в одном месте.
-   **Целостность данных**: Внешние ключи (FOREIGN KEY) гарантируют, что нельзя создать связь со станцией, которой нет в базе.
-   **Эффективность запросов**:
    -   Построение графа сводится к простому `SELECT station_from_id, station_to_id, distance_km FROM connections`.
    -   Легко найти все поезда, проходящие через станцию, или построить полный маршрут поезда, отсортировав `train_routes` по `sequence_order`.
    -   Использование `GEOGRAPHY` и пространственных индексов в PostGIS позволяет мгновенно находить ближайшие станции.